<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Sistema de Cola - Weather Video</title>
  <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #1a1a1a;
      color: #fff;
    }
    h1 { color: #60a5fa; }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      color: #9ca3af;
    }
    input, select {
      width: 100%;
      padding: 10px;
      background: #2d2d2d;
      border: 1px solid #404040;
      border-radius: 4px;
      color: #fff;
      font-size: 14px;
    }
    button {
      background: #60a5fa;
      color: #000;
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      margin-top: 10px;
    }
    button:hover { background: #3b82f6; }
    button:disabled {
      background: #4b5563;
      cursor: not-allowed;
    }
    .status {
      margin-top: 30px;
      padding: 20px;
      background: #2d2d2d;
      border-radius: 8px;
      border-left: 4px solid #60a5fa;
    }
    .progress-bar {
      width: 100%;
      height: 30px;
      background: #404040;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 10px;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #60a5fa, #3b82f6);
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: #000;
    }
    .log {
      margin-top: 20px;
      padding: 15px;
      background: #0a0a0a;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
    }
    .log-entry {
      margin-bottom: 8px;
      padding: 4px;
    }
    .log-info { color: #60a5fa; }
    .log-success { color: #10b981; }
    .log-error { color: #ef4444; }
    .video-result {
      margin-top: 20px;
      text-align: center;
    }
    video {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>ðŸŽ¬ Test Sistema de Cola - Weather Video</h1>

  <div class="form-group">
    <label>Ciudad:</label>
    <input type="text" id="city" value="Puerto Ordaz" placeholder="Nombre de la ciudad">
  </div>

  <div class="form-group">
    <label>Temperatura (Â°C):</label>
    <input type="number" id="temperature" value="28" placeholder="25">
  </div>

  <div class="form-group">
    <label>CondiciÃ³n:</label>
    <select id="condition">
      <option value="sunny">Soleado</option>
      <option value="cloudy">Nublado</option>
      <option value="rainy">Lluvioso</option>
      <option value="stormy">Tormenta</option>
    </select>
  </div>

  <div class="form-group">
    <label>Idioma:</label>
    <select id="language">
      <option value="es">EspaÃ±ol</option>
      <option value="en">English</option>
    </select>
  </div>

  <button id="renderBtn" onclick="startRender()">ðŸš€ Renderizar Video</button>

  <div id="statusContainer" class="status" style="display: none;">
    <h3>Estado del Job: <span id="jobId"></span></h3>
    <p><strong>Status:</strong> <span id="status">pending</span></p>
    <p><strong>Mensaje:</strong> <span id="message">Inicializando...</span></p>

    <div class="progress-bar">
      <div id="progressFill" class="progress-fill" style="width: 0%">0%</div>
    </div>

    <div class="log" id="log"></div>
  </div>

  <div id="videoResult" class="video-result" style="display: none;">
    <h3>âœ… Video Completado!</h3>
    <video id="videoPlayer" controls></video>
    <br>
    <a id="downloadLink" download>ðŸ“¥ Descargar Video</a>
  </div>

  <script>
    const API_URL = 'http://localhost:3001';
    let socket = null;
    let currentJobId = null;

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function updateProgress(progress, message, status) {
      document.getElementById('status').textContent = status;
      document.getElementById('message').textContent = message;
      const fill = document.getElementById('progressFill');
      fill.style.width = progress + '%';
      fill.textContent = Math.round(progress) + '%';
    }

    async function startRender() {
      const city = document.getElementById('city').value;
      const temperature = parseInt(document.getElementById('temperature').value);
      const condition = document.getElementById('condition').value;
      const language = document.getElementById('language').value;

      if (!city || !temperature) {
        alert('Por favor completa todos los campos');
        return;
      }

      // Deshabilitar botÃ³n
      document.getElementById('renderBtn').disabled = true;
      document.getElementById('statusContainer').style.display = 'block';
      document.getElementById('videoResult').style.display = 'none';
      document.getElementById('log').innerHTML = '';

      log('Enviando solicitud de renderizado...', 'info');

      try {
        // Hacer POST request
        const response = await fetch(`${API_URL}/api/render-video`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            city,
            weatherData: {
              city,
              temperature,
              condition,
              description: `Clima ${condition}`,
              date: new Date().toISOString().split('T')[0]
            },
            imageFilename: 'test-image.jpg',
            language
          })
        });

        const data = await response.json();
        currentJobId = data.jobId;

        document.getElementById('jobId').textContent = currentJobId;
        log(`Job creado: ${currentJobId}`, 'success');
        log(`Tiempo estimado: ${data.estimatedTime}`, 'info');

        // Conectar WebSocket
        connectSocket(currentJobId);

      } catch (error) {
        log(`Error: ${error.message}`, 'error');
        document.getElementById('renderBtn').disabled = false;
      }
    }

    function connectSocket(jobId) {
      log('Conectando a WebSocket...', 'info');

      socket = io(API_URL);

      socket.on('connect', () => {
        log('âœ… Conectado a WebSocket', 'success');
        socket.emit('subscribe:job', jobId);
        log(`ðŸ“¥ Suscrito a job:${jobId}`, 'success');
      });

      socket.on('job:progress', (data) => {
        log(`Progreso: ${data.message}`, 'info');
        updateProgress(data.progress, data.message, data.status);
      });

      socket.on('job:completed', (data) => {
        log('ðŸŽ‰ Video completado!', 'success');
        updateProgress(100, 'Video renderizado exitosamente', 'completed');

        // Mostrar video
        document.getElementById('videoResult').style.display = 'block';
        document.getElementById('videoPlayer').src = data.result.videoUrl;
        document.getElementById('downloadLink').href = data.result.videoUrl;
        document.getElementById('downloadLink').download = data.result.filename;

        log(`Video URL: ${data.result.videoUrl}`, 'success');

        // Re-habilitar botÃ³n
        document.getElementById('renderBtn').disabled = false;
        socket.disconnect();
      });

      socket.on('job:failed', (data) => {
        log(`âŒ Error: ${data.error}`, 'error');
        updateProgress(0, `Error: ${data.error}`, 'failed');
        document.getElementById('renderBtn').disabled = false;
        socket.disconnect();
      });

      socket.on('disconnect', () => {
        log('WebSocket desconectado', 'info');
      });
    }

    // Mostrar instrucciones
    window.addEventListener('load', () => {
      console.log('ðŸŽ¬ Test Cliente - Sistema de Cola');
      console.log('1. Completa los campos del formulario');
      console.log('2. Click en "Renderizar Video"');
      console.log('3. Observa el progreso en tiempo real');
      console.log('4. El video se mostrarÃ¡ cuando estÃ© listo');
    });
  </script>
</body>
</html>
